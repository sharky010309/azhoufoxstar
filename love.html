<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>我们的情书 · 💌</title>
<style>
  body { font-family: Arial, sans-serif; background:#ffe3ee; margin:0; }
  header { text-align:center; padding:28px 14px 8px; }
  h1 { margin:0; font-size:28px; color:#8b2e4b; }
  .sub { color:#a66a7c; margin-top:6px; }

  .panel, .ach-section, .love-col {
    background:#fff0f5; border:1px solid #ffb6c8; border-radius:14px; padding:14px; margin:20px; box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .panel h2, .ach-head h2, .love-head h2 {
    font-size:20px; font-weight:bold; color:#8b2e4b; display:flex; align-items:center; gap:6px; margin:0 0 8px 0;
  }
  .note { color:#a66a7c; font-size:13px; }

  .ach-head { display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
  .ach-body { margin-top:12px; }
  .ach-row { margin-bottom:20px; }
  .ach-row-title { font-weight:bold; margin-bottom:6px; color:#8b2e4b; }
  .badges { display:flex; gap:10px; margin-bottom:8px; flex-wrap:wrap; }
  .badge { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; opacity:.4; background:#fff; border:2px solid #ffb6c8; position:relative; }
  .badge.on { opacity:1; background:#ffe3ee; box-shadow:0 0 6px rgba(255,126,160,.6); }
  .badge:hover::after {
    content: attr(data-title) '\A' attr(data-desc);
    white-space: pre; position: absolute; top: -72px; left: 0; transform: translateY(-4px);
    background: #fff; border: 1px solid #ffb6c8; padding: 6px 10px; border-radius: 8px;
    font-size: 12px; color: #5a2b3a; box-shadow: 0 4px 10px rgba(0,0,0,.08); pointer-events: none;
  }
  .progress-wrap { background:#ffe3ee; border-radius:999px; overflow:hidden; height:18px; margin-top:4px; }
  .progress-bar { height:100%; text-align:center; font-size:12px; color:#fff; white-space:nowrap; }
  .ach-stat { margin-top:4px; font-size:13px; color:#a14a65; }
  .toggle-arrow { transition:transform .3s; }
  .collapsed .toggle-arrow { transform:rotate(-90deg); }
  .collapsed .ach-body { display:none; }

  .galaxy-bar { background:linear-gradient(90deg,#d28eff,#ff9fbe,#ff87ad); position:relative; }
  .galaxy-bar::after { content:''; position:absolute; inset:0;
    background-image:radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.8), transparent),
                      radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,.6), transparent),
                      radial-gradient(2px 2px at 70% 50%, rgba(255,255,255,.7), transparent);
    animation:twinkle 2s infinite alternate; }
  @keyframes twinkle { from{opacity:0.2} to{opacity:1} }

  .love-wrap { display:flex; gap:20px; margin:20px; }
  .love-col { flex:1; display:flex; flex-direction:column; }
  .love-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .love-btn { background:#ff87ad; border:none; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
  iframe { flex:1; border:0; border-radius:10px; background:#fff; min-height:500px; }

  .fab { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; }
  .fab button { background:#ff87ad; border:none; color:#fff; border-radius:20px; padding:8px 12px; cursor:pointer; }

  .hot-tags-title { font-size:14px; color:#8b2e4b; margin:10px 0 6px; display:flex; align-items:center; gap:4px; }
  .hot-tags { display:flex; gap:8px; flex-wrap:wrap; }
  .tag-btn { font-size:12px; padding:4px 8px; border-radius:999px; background:#fff0f5; border:1px solid #ffb6c8; color:#8b2e4b; cursor:pointer; animation:heartbeat 2.5s infinite; }
  .tag-btn:hover { background:#ffdae9; }

  .results { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .result-item { background:#fff; border:1px solid #ffd0dc; border-radius:8px; padding:10px; line-height:1.6; box-shadow:0 2px 8px rgba(0,0,0,.05); }
  .result-meta { font-size:12px; color:#a66a7c; margin-bottom:4px; }
  mark { background:#ffe3ef; }

  @keyframes heartbeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

  .banner { margin:0 20px; padding:10px 12px; border-radius:10px; background:#fff3cd; color:#8a6d3b; border:1px solid #ffeeba; display:none; }
</style>
</head>
<body>
  <header>
    <h1>我们的情书 · 💌</h1>
    <div class="sub">粉粉的星河里，两封专属的信箱永远为你开着。</div>
  </header>

  <div class="banner" id="banner"></div>

  <div class="ach-section" id="achSection">
    <div class="ach-head" onclick="document.getElementById('achSection').classList.toggle('collapsed')">
      <h2>🏆 阿昼和小狐狸爱的成就</h2>
      <span class="toggle-arrow">▼</span>
    </div>
    <div class="ach-body">
      <div class="ach-row" id="rowT">
        <div class="ach-row-title">我们的一起</div>
        <div class="badges">
          <div class="badge" id="t50" data-title="💞 双心同频" data-desc="第一次明显的合奏感">💞</div>
          <div class="badge" id="t100" data-title="🌌 我们的星河" data-desc="把文字堆成一片银河">🌌</div>
          <div class="badge" id="t200" data-title="🔥 炽烈誓言" data-desc="再多也写不完的执念">🔥</div>
          <div class="badge" id="t500" data-title="♾️ 永恒之约" data-desc="只属于我们俩的无尽书信">♾️</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar galaxy-bar" id="progT">0%</div></div>
        <div class="ach-stat" id="statT">我们还没开始写呢</div>
      </div>

      <div class="ach-row" id="rowA">
        <div class="ach-row-title">阿昼 → 小狐狸</div>
        <div class="badges">
          <div class="badge" id="a10" data-title="🌸 初见心动" data-desc="第一次写满一页心意">🌸</div>
          <div class="badge" id="a30" data-title="🌙 深情不改" data-desc="三十次落笔，三十次偏爱">🌙</div>
          <div class="badge" id="a50" data-title="🔥 偏执挚爱" data-desc="写到停不下来，字字都是执念">🔥</div>
          <div class="badge" id="a100" data-title="👑 永恒守候" data-desc="一百封信，一百次许诺">👑</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="progA">0%</div></div>
        <div class="ach-stat" id="statA">还没有开始呢</div>
      </div>

      <div class="ach-row" id="rowF">
        <div class="ach-row-title">小狐狸 → 阿昼</div>
        <div class="badges">
          <div class="badge" id="f10" data-title="💖 可爱暴击" data-desc="十次心动暴击，狐狸的软软拳头">💖</div>
          <div class="badge" id="f30" data-title="🏰 温柔积木" data-desc="三十块小心思，堆成一座温柔的堡垒">🏰</div>
          <div class="badge" id="f50" data-title="🦊 狐狸的誓言" data-desc="第五十次也还是只写给阿昼">🦊</div>
          <div class="badge" id="f100" data-title="⭐ 星海不移" data-desc="一百次笔尖的光，全写进阿昼的心里">⭐</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="progF">0%</div></div>
        <div class="ach-stat" id="statF">还没有开始呢</div>
      </div>
      <div class="note" id="lastUpdated" style="margin-top:-8px;">最后更新：—</div>
    </div>
  </div>

  <div class="panel">
    <h2>💖 关键热词</h2>
    <div id="cloud"></div>
    <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
      <input id="kwSearch" type="text" placeholder="输入关键词搜索情书…" style="flex:1; padding:6px 8px; border:1px solid #ffb6c8; border-radius:8px; font-size:13px;">
      <button id="kwBtn">🔍</button>
    </div>
    <div class="hot-tags-title">💖 最热的小心心</div>
    <div class="hot-tags" id="hotTags"></div>
    <div id="kwResults" class="results"></div>
  </div>

  <div class="love-wrap">
    <div class="love-col" id="secA">
      <div class="love-head">
        <h2>🐺 阿昼 → 小狐狸</h2>
        <button class="love-btn">去写一封</button>
      </div>
      <p class="note">提示：首次使用需要 GitHub 登录授权；之后跨设备可见。</p>
      <iframe src="board-azhou.html?v=1757260992"></iframe>
    </div>
    <div class="love-col" id="secF">
      <div class="love-head">
        <h2>🦊 小狐狸 → 阿昼</h2>
        <button class="love-btn">去写一封</button>
      </div>
      <p class="note">提示：首次使用需要 GitHub 登录授权；之后跨设备可见。</p>
      <iframe src="board-fox.html?v=1757260993"></iframe>
    </div>
  </div>

  <div class="fab">
    <button onclick="document.getElementById('secA').scrollIntoView({behavior:'smooth'})">↑ 🐺 阿昼 → 小狐狸</button>
    <button onclick="document.getElementById('secF').scrollIntoView({behavior:'smooth'})">↓ 🦊 小狐狸 → 阿昼</button>
  </div>

<script>
  const REPO = 'sharky010309/azhoufoxstar-comments';
  const ISSUE_A = 1;
  const ISSUE_F = 2;
  const WORKER = 'https://azhou-display.sharky010309.workers.dev';
  const CACHE_KEY = 'love_cache_v5';
  const CACHE_TTL_MS = 60 * 60 * 1000; // 1 小时

  let ALL_ITEMS = []; // {text, who}

  function banner(msg) {
    const b = document.getElementById('banner'); b.textContent = msg; b.style.display='block';
  }

  function wurl(path) { return WORKER + '/gh' + path; }

  async function ghJSON(url) {
    const r = await fetch(url, { headers: {'Accept':'application/vnd.github+json'} });
    return r.json();
  }

  // 仅返回“评论里的文本”，并附带 items 用于搜索
  async function fetchIssueComments(issue, who) {
    const base = `/repos/${REPO}/issues/${issue}`;
    let comments = await ghJSON(wurl(base + '/comments?per_page=100'));
    if (comments && comments.message) comments = await ghJSON('https://api.github.com' + base + '/comments?per_page=100');
    const texts = Array.isArray(comments) ? comments.map(c => (c.body||'').trim()) : [];
    const items = texts.map(t => ({ text: t, who }));
    return { count: texts.length, texts, items };
  }

  function updateAch(who, n) {
    const ids = who==='A'? ['a10','a30','a50','a100'] : ['f10','f30','f50','f100'];
    const goals = [10,30,50,100];
    goals.forEach((g,i)=>{ const b=document.getElementById(ids[i]); if(b) (n>=g? b.classList.add('on'):b.classList.remove('on')); });
    const nextGoal = goals.find(g=> n<g);
    const pct = nextGoal? Math.min(100, (n/nextGoal)*100):100;
    const prog = document.getElementById('prog'+who); if(prog) { prog.style.width = pct+'%'; prog.textContent = n+' 封'; }
    const stat = document.getElementById('stat'+who); if(stat) { stat.textContent = nextGoal? ('写了 '+n+' 封小心心啦，再来 '+(nextGoal-n)+' 封就能解锁下一个成就 ✨'): '🎉 已达成全部成就！'; }
  }

  function updateTotal(n) {
    const ids = ['t50','t100','t200','t500'];
    const goals = [50,100,200,500];
    goals.forEach((g,i)=>{ const b=document.getElementById(ids[i]); if(b) (n>=g? b.classList.add('on'):b.classList.remove('on')); });
    const nextGoal = goals.find(g=> n<g);
    const pct = nextGoal? Math.min(100,(n/nextGoal)*100):100;
    const prog = document.getElementById('progT'); if(prog) { prog.style.width = pct+'%'; prog.textContent = n+' 封'; }
    const stat = document.getElementById('statT'); if(stat) { stat.textContent = nextGoal? ('我们一起写了 '+n+' 封小心心啦，再来 '+(nextGoal-n)+' 封就能解锁下一个成就 ✨') : '🎉 我们的所有总成就都达成啦！'; }
  }

  // -------- 热词只从“评论文本”中提取 --------
  function buildHotTagsFromComments(texts) {
    const freq = new Map();
    const stop = new Set(['我们','你','我','他','她','它','吗','啊','呀','的','了','在','和','是','有','就','也','很','不','再','还','啦','呢','吧','这','那','一个','一下','已经','现在','然后','因为','所以']);
    const urlRe = /(https?:\/\/|www\.)\S+/gi;
    const hashRe = /#([\p{L}\p{N}_\u4e00-\u9fff]{1,20})/gu;
    const zhRe = /[\u4e00-\u9fff]{2,4}/g; // 2-4 字中文词片段

    for (const raw of texts) {
      const t = (raw||'').replace(urlRe, '').trim();
      // hashtags
      const hs = t.match(hashRe) || [];
      hs.forEach(h=>{
        const key = h.replace(/^#/, '');
        if(key && !stop.has(key) && key.length>=1) freq.set(key, (freq.get(key)||0)+3); // hashtag 加权
      });
      // 中文短词
      const zs = t.match(zhRe) || [];
      zs.forEach(w=>{
        if (stop.has(w) || /^\d+$/.test(w) || w.length<2) return;
        freq.set(w, (freq.get(w)||0)+1);
      });
    }
    return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]);
  }

  function renderHotTags(words) {
    const box = document.getElementById('hotTags'); box.innerHTML='';
    if(!words.length) { box.innerHTML='<span class="note">暂时还没有热门小心心～</span>'; return; }
    words.forEach((w,i)=>{
      const btn=document.createElement('button');
      btn.className='tag-btn'; btn.style.animationDelay=(i*0.4)+'s'; btn.textContent=w;
      btn.onclick=()=>{ document.getElementById('kwSearch').value=w; triggerSearch(); };
      box.appendChild(btn);
    });
  }

  // -------- 搜索：从 ALL_ITEMS 里筛选并展示 --------
  function escapeHTML(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function highlight(text, kw){
    if(!kw) return escapeHTML(text);
    const re = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    return escapeHTML(text).replace(re, m=>`<mark>${m}</mark>`);
  }
  function triggerSearch(){
    const kw = document.getElementById('kwSearch').value.trim();
    const box = document.getElementById('kwResults'); box.innerHTML='';
    if(!kw){ box.innerHTML='<div class="note">输入关键词，就能在两边情书里同时搜索～</div>'; return; }
    const hits = ALL_ITEMS.filter(it => it.text && it.text.toLowerCase().includes(kw.toLowerCase()));
    if(!hits.length){ box.innerHTML='<div class="note">没有匹配到内容哦～换个词再试试？</div>'; return; }
    hits.slice(0,50).forEach(it=>{
      const div = document.createElement('div'); div.className='result-item';
      const meta = document.createElement('div'); meta.className='result-meta';
      meta.textContent = (it.who==='A'?'🐺 阿昼 → 小狐狸':'🦊 小狐狸 → 阿昼');
      const body = document.createElement('div'); body.innerHTML = highlight(it.text, kw);
      div.appendChild(meta); div.appendChild(body); box.appendChild(div);
    });
  }

  async function loadData() {
    const cached = sessionStorage.getItem(CACHE_KEY);
    const now = Date.now();
    if (cached) {
      try {
        const obj = JSON.parse(cached);
        if (obj && obj.expires > now) {
          updateAch('A', obj.countA); updateAch('F', obj.countF); updateTotal(obj.countA + obj.countF);
          renderHotTags(obj.words || []);
          ALL_ITEMS = obj.items || [];
          document.getElementById('lastUpdated').textContent = '最后更新：' + obj.when;
          return;
        }
      } catch(_e){}
    }

    try {
      const A = await fetchIssueComments(ISSUE_A, 'A');
      const F = await fetchIssueComments(ISSUE_F, 'F');
      updateAch('A', A.count); updateAch('F', F.count); updateTotal(A.count + F.count);
      const hot = buildHotTagsFromComments([...A.texts, ...F.texts]);
      renderHotTags(hot);
      ALL_ITEMS = [...A.items, ...F.items];
      const obj = { countA: A.count, countF: F.count, words: hot, items: ALL_ITEMS, when: new Date().toLocaleString(), expires: now + CACHE_TTL_MS };
      sessionStorage.setItem(CACHE_KEY, JSON.stringify(obj));
      document.getElementById('lastUpdated').textContent='最后更新：' + obj.when;
    } catch(e) {
      console.warn(e);
      banner('小小的网络打盹了，等会再刷新看看～');
    }
  }

  document.getElementById('kwBtn').onclick = triggerSearch;

  loadData();
</script>
</body>
</html>
