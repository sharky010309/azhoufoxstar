<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>我们的情书 · 💌</title>
<style>
  body { font-family: Arial, sans-serif; background:#ffe3ee; margin:0; }
  header { text-align:center; padding:28px 14px 8px; }
  h1 { margin:0; font-size:28px; color:#8b2e4b; }
  .sub { color:#a66a7c; margin-top:6px; }

  .panel, .ach-section, .love-col {
    background:#fff0f5; border:1px solid #ffb6c8; border-radius:14px; padding:14px; margin:20px; box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .panel h2, .ach-head h2, .love-head h2 {
    font-size:20px; font-weight:bold; color:#8b2e4b; display:flex; align-items:center; gap:6px; margin:0 0 8px 0;
  }
  .note { color:#a66a7c; font-size:13px; }

  /* Achievements */
  .ach-head { display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
  .ach-body { margin-top:12px; }
  .ach-row { margin-bottom:20px; }
  .ach-row-title { font-weight:bold; margin-bottom:6px; color:#8b2e4b; }
  .badges { display:flex; gap:10px; margin-bottom:8px; }
  .badge { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; opacity:.4; background:#fff; border:2px solid #ffb6c8; position:relative; }
  .badge.on { opacity:1; background:#ffe3ee; box-shadow:0 0 6px rgba(255,126,160,.6); }
  .progress-wrap { background:#ffe3ee; border-radius:999px; overflow:hidden; height:18px; margin-top:4px; }
  .progress-bar { height:100%; text-align:center; font-size:12px; color:#fff; white-space:nowrap; }
  .ach-stat { margin-top:4px; font-size:13px; color:#a14a65; }
  .toggle-arrow { transition:transform .3s; }
  .collapsed .toggle-arrow { transform:rotate(-90deg); }
  .collapsed .ach-body { display:none; }

  /* Galaxy progress bar */
  .galaxy-bar { background:linear-gradient(90deg,#d28eff,#ff9fbe,#ff87ad); position:relative; }
  .galaxy-bar::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0;
    background-image:radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.8), transparent),
                      radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,.6), transparent),
                      radial-gradient(2px 2px at 70% 50%, rgba(255,255,255,.7), transparent);
    background-repeat:repeat; animation:twinkle 2s infinite alternate; }
  @keyframes twinkle { from{opacity:0.2} to{opacity:1} }

  /* Love letters side by side */
  .love-wrap { display:flex; gap:20px; margin:20px; }
  .love-col { flex:1; display:flex; flex-direction:column; }
  .love-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .love-btn { background:#ff87ad; border:none; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
  iframe { flex:1; border:0; border-radius:10px; background:#fff; min-height:500px; }

  /* Floating buttons */
  .fab { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; }
  .fab button { background:#ff87ad; border:none; color:#fff; border-radius:20px; padding:8px 12px; cursor:pointer; }

  /* Hot tags */
  .hot-tags-title { font-size:14px; color:#8b2e4b; margin:10px 0 6px; display:flex; align-items:center; gap:4px; }
  .hot-tags { display:flex; gap:8px; flex-wrap:wrap; }
  .tag-btn { font-size:12px; padding:4px 8px; border-radius:999px; background:#fff0f5; border:1px solid #ffb6c8; color:#8b2e4b; cursor:pointer; animation:heartbeat 2.5s infinite; }
  .tag-btn:hover { background:#ffdae9; }
  @keyframes heartbeat {
    0%, 100% { transform:scale(1); }
    50% { transform:scale(1.1); }
  }

  /* Banner */
  .banner { margin:0 20px; padding:10px 12px; border-radius:10px; background:#fff3cd; color:#8a6d3b; border:1px solid #ffeeba; display:none; }
</style>
</head>
<body>
  <header>
    <h1>我们的情书 · 💌</h1>
    <div class="sub">粉粉的星河里，两封专属的信箱永远为你开着。</div>
  </header>

  <div class="banner" id="banner"></div>

  <!-- 成就区 -->
  <div class="ach-section" id="achSection">
    <div class="ach-head" onclick="document.getElementById('achSection').classList.toggle('collapsed')">
      <h2>🏆 阿昼和小狐狸爱的成就</h2>
      <span class="toggle-arrow">▼</span>
    </div>
    <div class="ach-body">
      <div class="ach-row" id="rowT">
        <div class="ach-row-title">我们的一起</div>
        <div class="badges">
          <div class="badge" id="t50" title="💞 双心同频">💞</div>
          <div class="badge" id="t100" title="🌌 我们的星河">🌌</div>
          <div class="badge" id="t200" title="🔥 炽烈誓言">🔥</div>
          <div class="badge" id="t500" title="♾️ 永恒之约">♾️</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar galaxy-bar" id="progT">0%</div></div>
        <div class="ach-stat" id="statT">我们还没开始写呢</div>
      </div>

      <div class="ach-row" id="rowA">
        <div class="ach-row-title">阿昼 → 小狐狸</div>
        <div class="badges">
          <div class="badge" id="a10">🌸</div>
          <div class="badge" id="a30">🌙</div>
          <div class="badge" id="a50">🔥</div>
          <div class="badge" id="a100">👑</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="progA">0%</div></div>
        <div class="ach-stat" id="statA">还没有开始呢</div>
      </div>

      <div class="ach-row" id="rowF">
        <div class="ach-row-title">小狐狸 → 阿昼</div>
        <div class="badges">
          <div class="badge" id="f10">💖</div>
          <div class="badge" id="f30">🏰</div>
          <div class="badge" id="f50">🦊</div>
          <div class="badge" id="f100">⭐</div>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="progF">0%</div></div>
        <div class="ach-stat" id="statF">还没有开始呢</div>
      </div>
      <div class="note" id="lastUpdated" style="margin-top:-8px;">最后更新：—</div>
    </div>
  </div>

  <!-- 热词区 -->
  <div class="panel">
    <h2>💖 关键热词</h2>
    <div id="cloud"></div>
    <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
      <input id="kwSearch" type="text" placeholder="输入关键词搜索情书…" style="flex:1; padding:6px 8px; border:1px solid #ffb6c8; border-radius:8px; font-size:13px;">
      <button id="kwBtn">🔍</button>
    </div>
    <div class="hot-tags-title">💖 最热的小心心</div>
    <div class="hot-tags" id="hotTags"></div>
    <div id="kwResults" class="note" style="margin-top:8px;"></div>
  </div>

  <!-- 情书区左右布局 -->
  <div class="love-wrap">
    <div class="love-col" id="secA">
      <div class="love-head">
        <h2>🐺 阿昼 → 小狐狸</h2>
        <button class="love-btn">去写一封</button>
      </div>
      <p class="note">提示：首次使用需要 GitHub 登录授权；之后跨设备可见。</p>
      <iframe src="board-azhou.html?v=1757255257"></iframe>
    </div>
    <div class="love-col" id="secF">
      <div class="love-head">
        <h2>🦊 小狐狸 → 阿昼</h2>
        <button class="love-btn">去写一封</button>
      </div>
      <p class="note">提示：首次使用需要 GitHub 登录授权；之后跨设备可见。</p>
      <iframe src="board-fox.html?v=1757255258"></iframe>
    </div>
  </div>

  <div class="fab">
    <button onclick="document.getElementById('secA').scrollIntoView({behavior:'smooth'})">↑ 🐺 阿昼 → 小狐狸</button>
    <button onclick="document.getElementById('secF').scrollIntoView({behavior:'smooth'})">↓ 🦊 小狐狸 → 阿昼</button>
  </div>

<script>
  const REPO = 'sharky010309/azhoufoxstar-comments';
  const ISSUE_A = 1;
  const ISSUE_F = 2;
  const cacheKey = 'love_cache_v1';

  function showBanner(msg) {
    const b = document.getElementById('banner');
    b.textContent = msg;
    b.style.display = 'block';
  }

  function nowStr() {
    const d = new Date(); const p=n=>n.toString().padStart(2,'0');
    return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());
  }

  async function ghJSON(url) {
    const r = await fetch(url);
    const j = await r.json();
    if (j && j.message && /rate limit/i.test(j.message)) throw new Error('RATE_LIMIT');
    return j;
  }

  async function fetchIssueAll(issue) {
    const meta = await ghJSON(`https://api.github.com/repos/${REPO}/issues/${issue}`);
    const comments = await ghJSON(`https://api.github.com/repos/${REPO}/issues/${issue}/comments?per_page=100`);
    const arr = [];
    if (meta && (meta.title || meta.body)) arr.push({body: (meta.title? meta.title+'\n':'') + (meta.body||'')});
    if (Array.isArray(comments)) comments.forEach(c => arr.push({body:c.body||''}));
    const count = (meta.comments||0) + 1;
    return {items:arr, count};
  }

  function updateAch(who, n) {
    const ids = who==='A'? ['a10','a30','a50','a100'] : ['f10','f30','f50','f100'];
    const goals = [10,30,50,100];
    goals.forEach((g,i)=>{ const b=document.getElementById(ids[i]); if(b) (n>=g? b.classList.add('on'):b.classList.remove('on')); });
    const nextGoal = goals.find(g=> n<g);
    const pct = nextGoal? Math.min(100, (n/nextGoal)*100):100;
    const prog = document.getElementById('prog'+who); if(prog) { prog.style.width = pct+'%'; prog.textContent = n+' 封'; }
    const stat = document.getElementById('stat'+who); if(stat) { stat.textContent = nextGoal? ('写了 '+n+' 封小心心啦，再来 '+(nextGoal-n)+' 封就能解锁下一个成就 ✨'): '🎉 已达成全部成就！'; }
  }

  function updateTotal(n) {
    const ids = ['t50','t100','t200','t500'];
    const goals = [50,100,200,500];
    goals.forEach((g,i)=>{ const b=document.getElementById(ids[i]); if(b) (n>=g? b.classList.add('on'):b.classList.remove('on')); });
    const nextGoal = goals.find(g=> n<g);
    const pct = nextGoal? Math.min(100,(n/nextGoal)*100):100;
    const prog = document.getElementById('progT'); if(prog) { prog.style.width = pct+'%'; prog.textContent = n+' 封'; }
    const stat = document.getElementById('statT'); if(stat) { stat.textContent = nextGoal? ('我们一起写了 '+n+' 封小心心啦，再来 '+(nextGoal-n)+' 封就能解锁下一个成就 ✨') : '🎉 我们的所有总成就都达成啦！'; }
  }

  function buildHotTags(items) {
    const stop = new Set(['的','了','和','也','在','是','就','都','我','你','他','她','它','我们','你们','他们','一个','这个','那个','吗','吧','呢','呀','哦','啊','让','把','很','还','又','被','与','对','给','到','于','上','下','中','去','来','更','最','多','少','没','有','会','要','能','但','而','如果','因为','所以']);
    const tokenizeCN = (text) => { const arr=[]; const s=(text||'').replace(/\s+/g,''); for(let i=0;i<s.length-1;i++){ const w=s.slice(i,i+2); if(/[\u4e00-\u9fa5]{2}/.test(w) && !stop.has(w)) arr.push(w); } return arr; };
    const tokenizeEN = (text) => (text||'').toLowerCase().split(/[^a-z0-9#\+_]+/i).filter(x=>x && x.length>1 && !/^\d+$/.test(x));
    const extractTags = (text) => (text.match(/#([\p{Script=Han}a-zA-Z0-9_\-]{1,30})/gu)||[]).map(x=>x.replace(/^#/,'')).filter(Boolean);

    const freq = new Map(); const bump=(k,n=1)=>freq.set(k,(freq.get(k)||0)+n);
    items.forEach(it=>{ const t=it.body||''; extractTags(t).forEach(tag=>bump('#'+tag,3)); tokenizeCN(t).forEach(w=>bump(w,1)); tokenizeEN(t).forEach(w=>bump(w, w.startsWith('#')?2:1)); });
    return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]);
  }

  function renderHotTags(words) {
    const box = document.getElementById('hotTags'); box.innerHTML='';
    if(!words.length) { box.innerHTML='<span class="note">暂时还没有热门小心心～</span>'; return; }
    words.forEach((w,i)=>{ const btn=document.createElement('button'); btn.className='tag-btn'; btn.style.animationDelay=(i*0.4)+'s'; btn.textContent=w; btn.onclick=()=>{ document.getElementById('kwSearch').value=w; document.getElementById('kwBtn').click(); document.getElementById('kwResults').scrollIntoView({behavior:'smooth',block:'center'}); }; box.appendChild(btn); });
  }

  async function initData() {
    try {
      // cache
      const cache = sessionStorage.getItem(cacheKey);
      if (cache) {
        const o = JSON.parse(cache);
        updateAch('A', o.countA); updateAch('F', o.countF); updateTotal(o.countA + o.countF); renderHotTags(o.words);
        document.getElementById('lastUpdated').textContent='最后更新：' + o.when;
      }
      // live fetch
      const A = await fetchIssueAll(ISSUE_A);
      const F = await fetchIssueAll(ISSUE_F);
      updateAch('A', A.count); updateAch('F', F.count); updateTotal(A.count + F.count);
      const words = buildHotTags([...A.items, ...F.items]);
      renderHotTags(words);
      const o = {countA:A.count, countF:F.count, words, when: nowStr()};
      sessionStorage.setItem(cacheKey, JSON.stringify(o));
      document.getElementById('lastUpdated').textContent='最后更新：' + o.when;
    } catch(e) {
      if (e && e.message==='RATE_LIMIT') {
        showBanner('GitHub API 今天有点害羞（达到未登录的访问上限），稍后再打开看看，或先登录 GitHub 再刷新～');
      } else {
        showBanner('数据拉取出了点小插曲，等会再试试～');
      }
    }
  }

  // 搜索按钮占位
  document.getElementById('kwBtn').onclick = ()=>{ const kw=document.getElementById('kwSearch').value.trim(); document.getElementById('kwResults').textContent = kw? '（搜索结果展示 '+kw+'，待实现）':'请输入关键词'; };

  initData();
</script>
</body>
</html>
